
;(function($){
    $.timeliner=function(options){
        if($.timeliners==null){
            $.timeliners={options:[]};
            $.timeliners.options.push(options);
        }
        else{
            $.timeliners.options.push(options);
        }
        $(document).ready(function(){
            for(var i=0;i<$.timeliners.options.length;i++){
                startTimeliner($.timeliners.options[i]);
            }
        });
    }
    function startTimeliner(options){
        var settings={
            timelineContainer:options['timelineContainer']||'#timelineContainer',
            timelineEXContent:options['timelineEXContent']||'.timelineEvent',
            timelineSection:options['timelineSection']||'.timelineMajor',
            timelineSectionMarker:options['timelineSectionMarker']||'.timelineMajorMarker',
            timelineTriggerContainer:options['timelineTriggerContainer']||'.timelineMinor dt',
            timelineTriggerAnchor:options['timelineTriggerAnchor']||'a',
            EXContentIdSuffix:options['timelineEXContentSuffix']||'EX',
            oneOpen:options['oneOpen']||false,
            startState:options['startState']||'closed',
            startOpen:options['startOpen']||[],
            baseSpeed:options['baseSpeed']||200,
            speed:options['speed']||4,
            fontOpen:options['fontOpen']||'1.2em',
            fontClosed:options['fontClosed']||'1em',
            expandAllText:options['expandAllText']||'+ expand all',
            collapseAllText:options['collapseAllText']||'- collapse all'
        };
        function openEvent(eventHeading,eventBody){
            $(eventHeading)
                .removeClass('closed')
                .addClass('open')
                .animate({fontSize:settings.fontOpen},settings.baseSpeed);
            $(eventBody).show(settings.speed*settings.baseSpeed);
        }
        function closeEvent(eventHeading,eventBody){
            $(eventHeading)
                .animate({fontSize:settings.fontClosed},0)
                .removeClass('open')
                .addClass('closed');
            $(eventBody).hide(settings.speed*settings.baseSpeed);
        }
        if($(settings.timelineContainer).data('started')){
            return;
        }else{
            $(settings.timelineContainer).data('started',true);
            $(settings.timelineContainer+" "+".expandAll").html(settings.expandAllText);
            $(settings.timelineContainer+" "+".collapseAll").html(settings.collapseAllText);
            if(settings.startState==='closed')
            {
                $(settings.timelineContainer+" "+settings.timelineEXContent).hide();
                $.each($(settings.startOpen),function(index,value){
                    openEvent($(value).find(settings.timelineTriggerAnchor),$(value+settings.EXContentIdSuffix));
                });
            }else{
                openEvent($(settings.timelineContainer+" "+settings.timelineTriggerContainer+" "+settings.timelineTriggerAnchor),$(settings.timelineContainer+" "+settings.timelineEXContent));
            }
            $(settings.timelineContainer).on("click",settings.timelineTriggerContainer,function(){
                var currentId=$(this).attr('id');
                if($(this).find(settings.timelineTriggerAnchor).is('.open'))
                {
                    closeEvent($(settings.timelineTriggerAnchor,this),$("#"+currentId+settings.EXContentIdSuffix))
                }else{
                    if(settings.oneOpen==true){
                        closeEvent($(this).parents(settings.timelineContainer).find(settings.timelineTriggerAnchor,settings.timelineTriggerContainer),$(this).parents(settings.timelineContainer).find(settings.timelineEXContent));
                    }
                    openEvent($(settings.timelineTriggerAnchor,this),$("#"+currentId+settings.EXContentIdSuffix));
                }
            });
            $(settings.timelineContainer).on("click",settings.timelineSectionMarker,function()
            {
                var numEvents=$(this).parents(settings.timelineSection).find(settings.timelineTriggerContainer).length;
                var numOpen=$(this).parents(settings.timelineSection).find('.open').length;
                if(settings.oneOpen==true){
                    closeEvent($(this).parents(settings.timelineContainer).find(settings.timelineTriggerAnchor,settings.timelineTriggerContainer),$(this).parents(settings.timelineContainer).find(settings.timelineEXContent));
                }
                if(numEvents>numOpen)
                {
                    openEvent($(this).parents(settings.timelineSection).find(settings.timelineTriggerAnchor,settings.timelineTriggerContainer),$(this).parents(settings.timelineSection).find(settings.timelineEXContent));
                }else{
                    closeEvent($(this).parents(settings.timelineSection).find("dl.timelineMinor a"),$(this).parents(settings.timelineSection).find(settings.timelineEXContent));
                }
            });
            $(settings.timelineContainer+" "+".expandAll").click(function()
            {
                if($(this).hasClass('expanded'))
                {
                    closeEvent($(this).parents(settings.timelineContainer).find(settings.timelineTriggerAnchor,settings.timelineTriggerContainer),$(this).parents(settings.timelineContainer).find(settings.timelineEXContent));
                    $(this).removeClass('expanded').html(settings.expandAllText);
                }else{
                    openEvent($(this).parents(settings.timelineContainer).find(settings.timelineTriggerAnchor,settings.timelineTriggerContainer),$(this).parents(settings.timelineContainer).find(settings.timelineEXContent));
                    $(this).addClass('expanded').html(settings.collapseAllText);
                }
            });
        }
    };
})(jQuery);
